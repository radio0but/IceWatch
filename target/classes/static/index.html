<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" type="image/png" href="${favicon}">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${radio.plainTitle}</title>
  <link rel="stylesheet" href="/css/app.css">
</head>
<body>
  <h1>${radio.title}</h1>
  <p>${welcome.message}</p>
  ${custom.html}

  <div class="tabs">
    <button class="tab-button active" data-tab="radio">ðŸŽ§ Radio</button>
    <button class="tab-button" data-tab="video">ðŸŽ¥ VidÃ©o</button>
    ${logout.button}
  </div>

  <div id="tab-radio" class="tab-content active">
    <div id="player-container">Chargement du lecteur audioâ€¦</div>
    <div id="metadata">Chargement des infosâ€¦</div>
    <div id="carousel-wrapper" style="display:none">
      <div id="carousel">
        <div class="carousel-inner" id="carousel-inner"></div>
        <button id="prev-button" class="carousel-button">â®œ</button>
        <button id="next-button" class="carousel-button">â®ž</button>
      </div>
    </div>
  </div>

  <div id="tab-video" class="tab-content">
    <div id="video-container">Chargement du lecteur vidÃ©oâ€¦</div>
  </div>

  ${logout.tab}

<script>
let currentSlide = 0;
let isAutoScrolling = false; // Flag pour savoir si le dÃ©filement auto est activÃ©
let scrollInterval; // Pour contrÃ´ler l'intervalle de dÃ©filement automatique

const API_BASE = "https://radio.boogiepit.com";

// Fonction pour rÃ©cupÃ©rer le token
async function fetchToken() {
  const res = await fetch(`${API_BASE}/auth/token`);
  const { token } = await res.json();
  return token;
}

// Fonction pour configurer l'audio
async function setupAudio(token) {
  const audio = document.createElement("audio");
  audio.src = `${API_BASE}/radio?token=${encodeURIComponent(token)}`;
  audio.controls = true;
  audio.autoplay = false;
  document.getElementById("player-container").innerHTML = "";
  document.getElementById("player-container").appendChild(audio);
}

// Fonction pour configurer la vidÃ©o
async function setupVideo(token) {
  const iframe = document.createElement("iframe");
  iframe.src = `${API_BASE}/owncast/embed/video?token=${encodeURIComponent(token)}`;
  iframe.width = "550";
  iframe.height = "350";
  iframe.allowFullscreen = true;
  iframe.style.border = "none";
  document.getElementById("video-container").innerHTML = "";
  document.getElementById("video-container").appendChild(iframe);
}

// Fonction de dÃ©filement manuel des slides (avec les flÃ¨ches)
function scrollCarousel(dir) {
  const container = document.getElementById("carousel-inner");
  const total = container.children.length;
  const cardWidth = container.children[0].offsetWidth; // Largeur d'une carte
  currentSlide = (currentSlide + dir + total) % total;

  container.style.transition = "transform 0.5s ease-in-out";  // Transition fluide
  container.style.transform = `translateX(-${currentSlide * cardWidth}px)`;

  resetAutoScroll(); // RÃ©initialiser l'auto dÃ©filement lorsque l'utilisateur interagit
}

// Fonction de dÃ©filement automatique
function startAutoScroll() {
  const container = document.getElementById("carousel-inner");
  const total = container.children.length;
  const cardWidth = container.children[0].offsetWidth; // Largeur d'une carte

  function scrollContinuously() {
    if (!isAutoScrolling) return; // Ne fait rien si l'utilisateur interagit

    container.style.transition = "transform 0.5s ease-in-out"; // Transition fluide
    currentSlide = (currentSlide + 1) % total;
    container.style.transform = `translateX(-${currentSlide * cardWidth}px)`;
  }

  // DÃ©marre le dÃ©filement automatique Ã  chaque 5 secondes
  scrollInterval = setInterval(scrollContinuously, 5000); // Intervalle de 5 secondes
}

// Fonction pour arrÃªter le dÃ©filement automatique
function stopAutoScroll() {
  clearInterval(scrollInterval);
  isAutoScrolling = false;
}

// Fonction pour dÃ©marrer l'auto-scroll 5 secondes aprÃ¨s le chargement
function startAutoScrollAfterDelay() {
  setTimeout(() => {
    isAutoScrolling = true;
    startAutoScroll();
  }, 5000); // DÃ©marre aprÃ¨s 5 secondes
}

// Fonction pour mettre Ã  jour les mÃ©tadonnÃ©es
async function updateMetadata() {
  try {
    const res = await fetch(`${API_BASE}/radio/metadata/enriched`);
    const data = await res.json();
    const title = data.title || "Inconnu";
    const artist = data.artist || "";

    document.getElementById("metadata").innerText = artist
      ? `ðŸŽ¶ ${artist} â€“ ${title}`
      : `ðŸŽ¶ En cours : ${title}`;

    const allAlbums = data.allAlbums;
    if (Array.isArray(allAlbums) && allAlbums.length > 0) {
      const container = document.getElementById("carousel-inner");
      container.innerHTML = "";

      // Pour chaque album, on crÃ©e et ajoute une carte
      allAlbums.forEach(a => {
        const albumCard = document.createElement('div');
        albumCard.classList.add('album-card');
        
        // On crÃ©e un contenu pour la carte d'album
        albumCard.innerHTML = `
          <h2>Parution</h2>
          <p>Les informations proviennent de MusicBrainz.</p>
          <p><strong>${a.date || 'Date inconnue'}</strong></p>
          <p>${a.album}</p>
          <img src="${a.cover}" onerror="this.src='/album.png'" alt="Jaquette">
        `;

        // On ajoute la carte d'album au conteneur du carrousel
        container.appendChild(albumCard);
      });

      document.getElementById("carousel-wrapper").style.display = "flex";
    } else {
      document.getElementById("carousel-wrapper").style.display = "none";
    }
  } catch (err) {
    document.getElementById("metadata").innerText = "Erreur de chargement des mÃ©tadonnÃ©es.";
    document.getElementById("carousel-wrapper").style.display = "none";
  }
}

window.addEventListener("DOMContentLoaded", async () => {
  try {
    const token = await fetchToken();
    await setupAudio(token);
    await setupVideo(token);
    updateMetadata();
    startAutoScrollAfterDelay(); // DÃ©marre le dÃ©filement automatique aprÃ¨s 5 secondes de dÃ©lai
  } catch (err) {
    console.error("Erreur d'initialisation :", err);
    document.getElementById("player-container").innerText =
      "Erreur de lecture audio.";
    document.getElementById("video-container").innerText =
      "Erreur de lecture vidÃ©o.";
  }

  // GÃ©rer l'activation des onglets
  document.querySelectorAll(".tab-button").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      btn.classList.add("active");
      const target = document.getElementById(`tab-${btn.dataset.tab}`);
      if (target) target.classList.add("active");
    });
  });

  // Ajout des Ã©vÃ©nements pour les flÃ¨ches
  document.getElementById("prev-button").addEventListener("click", () => {
    scrollCarousel(-1);
    stopAutoScroll(); // ArrÃªter l'auto dÃ©filement lors de l'interaction manuelle
  });

  document.getElementById("next-button").addEventListener("click", () => {
    scrollCarousel(1);
    stopAutoScroll(); // ArrÃªter l'auto dÃ©filement lors de l'interaction manuelle
  });
});
</script>

</body>
</html>
